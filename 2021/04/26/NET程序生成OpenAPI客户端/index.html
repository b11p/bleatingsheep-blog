<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>.NET程序生成OpenAPI客户端 | bleatingsheep 的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">.NET程序生成OpenAPI客户端</h1><a id="logo" href="/.">bleatingsheep 的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-4-4"><div class="content_container"><div class="post"><h1 class="post-title">.NET程序生成OpenAPI客户端</h1><div class="post-meta">2021-04-26</div><a class="disqus-comment-count" href="/2021/04/26/NET%E7%A8%8B%E5%BA%8F%E7%94%9F%E6%88%90OpenAPI%E5%AE%A2%E6%88%B7%E7%AB%AF/#vcomment"><span class="valine-comment-count" data-xid="/2021/04/26/NET%E7%A8%8B%E5%BA%8F%E7%94%9F%E6%88%90OpenAPI%E5%AE%A2%E6%88%B7%E7%AB%AF/"></span><span> 条评论</span></a><div class="post-content"><p>当使用 ASP.NET Core 实现 Web API 服务时，可以用 Swagger 生成 <code>openapi.json</code> 文件及对应文档。</p>
<span id="more"></span>

<h2 id="在-Visual-Studio-2019-中操作"><a href="#在-Visual-Studio-2019-中操作" class="headerlink" title="在 Visual Studio 2019 中操作"></a>在 Visual Studio 2019 中操作</h2><h3 id="添加服务"><a href="#添加服务" class="headerlink" title="添加服务"></a>添加服务</h3><p>首先新建一个 C# 项目，右键点击项目，点“添加”、“已连接的服务”，然后按步骤添加 OpenAPI 服务即可。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>传入新建的 <code>HttpClient</code> 及 <code>baseUrl</code> 即可使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var httpClient &#x3D; new HttpClient();</span><br><span class="line">var api &#x3D; new MyApi(&quot;https:&#x2F;&#x2F;example.com&#x2F;&quot;, httpClient);</span><br><span class="line">var result &#x3D; await api.GetBindingAsync(parameters);</span><br></pre></td></tr></table></figure>

<h2 id="不使用-IDE"><a href="#不使用-IDE" class="headerlink" title="不使用 IDE"></a>不使用 IDE</h2><p>Visual Studio 实际调用了 <code>Microsoft.dotnet-openapi</code> 来生成客户端代码。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/aspnet/core/web-api/microsoft.dotnet-openapi?view=aspnetcore-5.0">文档</a>中也提了一部分使用方法，但是十分含糊。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>首先确保已安装 .NET SDK。然后执行命令安装工具。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install --global Microsoft.dotnet-openapi</span><br></pre></td></tr></table></figure>

<p>若要升级工具，执行下列代码。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool update --global Microsoft.dotnet-openapi</span><br></pre></td></tr></table></figure>

<h3 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet openapi --help</span><br></pre></td></tr></table></figure>

<p>执行此命令会显示帮助</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">OpenApi reference management tool 5.0.5+b7a2ec8c7ed6b48857af0a69688a73e8c14fe6cb</span><br><span class="line"></span><br><span class="line">Usage: openapi [options] [command]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?|-h|--help  Show help information</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  add</span><br><span class="line">  refresh</span><br><span class="line">  remove</span><br><span class="line"></span><br><span class="line">Use &quot;openapi [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure>

<p>可以看到总共有三条命令，先看看 <code>add</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet openapi add --help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Usage: openapi add [options] [command]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p|--updateProject  The project file update.</span><br><span class="line">  -?|-h|--help        Show help information</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  file</span><br><span class="line">  url</span><br></pre></td></tr></table></figure>
<p>显示出了用法，注意这时 <code>file</code> 和 <code>url</code> 都是命令，不是参数。继续想看帮助</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet openapi add url --help</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Usage: openapi add url [arguments] [options]</span><br><span class="line"></span><br><span class="line">Arguments:</span><br><span class="line">  source-URL  The OpenAPI file to add. This must be a URL to a remote OpenAPI file.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p|--updateProject   The project file update.</span><br><span class="line">  -c|--code-generator  The code generator to use. Defaults to &#39;NSwagCSharp&#39;.</span><br><span class="line">  --output-file        The destination to download the remote OpenAPI file to.</span><br><span class="line">  -?|-h|--help         Show help information</span><br></pre></td></tr></table></figure>

<p>这就是完整用法了。</p>
<h3 id="添加-API-引用并调用-API"><a href="#添加-API-引用并调用-API" class="headerlink" title="添加 API 引用并调用 API"></a>添加 API 引用并调用 API</h3><p>按照上面的命令，在项目目录执行以下代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet openapi add url &quot;https:&#x2F;&#x2F;api.bleatingsheep.org&#x2F;swagger&#x2F;v1&#x2F;swagger.json&quot; --output-file &quot;HydrantApi.json&quot;</span><br></pre></td></tr></table></figure>

<p>然后项目目录中就会出现 <code>HydrantApi.json</code> 文件。运行 <code>dotnet build</code>，然后就可以使用 API 了，默认的类名是文件名+<code>Client</code>，在这个例子里，也就是 <code>HydrantApiClient</code>，使用方法同上。</p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>可以用 <code>dotnet openapi refresh</code> 命令更新 <code>json</code>，然后用 <code>dotnet build</code> 更新生成的代码。</p>
</div><div class="tags"><a href="/tags/NET/"><i class="fa fa-tag"></i>.NET</a></div><div class="post-nav"><a class="pre" href="/2021/05/21/CSharp%E4%B8%AD%E7%BC%96%E8%AF%91%E6%9C%9F%E5%8F%AF%E4%BB%A5%E6%A3%80%E6%B5%8B%E5%88%B0%E7%9A%84%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%A4%B1%E8%B4%A5/">C#中编译期可以检测到的类型转换失败</a><a class="next" href="/2021/04/03/%E7%94%A8-C-%E4%B8%8E-NET-%E4%B8%AD%E7%9A%84%E5%86%85%E6%8F%92%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BB%84%E8%A3%85%E6%B6%88%E6%81%AF/">用 C# 与 .NET 中的内插字符串组装消息</a></div><div id="vcomment"></div><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'eF5widAEDbOaAndcDJGQp7Rh-gzGzoHsz',
  appKey:'WyOY5xy1Lo6xy1FLLTbpkwEM',
  placeholder:'',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  path: 'bleatingsheep.org/_posts/NET程序生成OpenAPI客户端.md',
  requiredFields: ['nick','mail']
})
</script></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">bleatingsheep 的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>